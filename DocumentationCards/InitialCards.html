<style>
  #DefaultDocsContentCard1 {
    height: calc(100% - 20px);
    overflow-y: scroll;
  }

  #flowchart {
    height: 1000vh;
    width: 1000vw;
    background: transparent;
  }

  #chart_container {
    width: 100%;
    height: calc(100vh - 50px);
    overflow: hidden;
    background: white;
    border-radius: 15px;
  }

  body:has(.switch__input:not(:checked)) #chart_container {
    background: black;
  }

  .flowchart-container {
    border: 1px solid #ddd;
    margin-bottom: 10px;
    border-radius: 15px;
  }

  .draggable_operators_label {
    margin-bottom: 5px;
  }

  .draggable_operators_divs {
    margin-bottom: 20px;
  }

  .draggable_operator {
    display: inline-block;
    padding: 2px 5px 2px 5px;
    border: 1px solid #ccc;
    cursor: grab;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  .flowchart-operator .flowchart-operator-title,
  .flowchart-operator {
    border-radius: 15px;
    background: transparent;
    width: fit-content;
    height: fit-content;
  }
</style>
<div
  id="DefaultDocsContentCard1"
  class="DocsCard">
  Click on an item on the left<br />The below is order of operations: (not
  accurate - meant as a placeholder for now)<br />
  <div id="chart_container">
    <div
      class="flowchart-container"
      id="flowchart"></div>
  </div>
  <div class="draggable_operators">
    <div class="draggable_operators_label">
      Operators (drag and drop them in the flowchart):
    </div>
    <div class="draggable_operators_divs">
      <div
        class="draggable_operator"
        data-nb-inputs="1"
        data-nb-outputs="0">
        1 input
      </div>
      <div
        class="draggable_operator"
        data-nb-inputs="0"
        data-nb-outputs="1">
        1 output
      </div>
      <div
        class="draggable_operator"
        data-nb-inputs="1"
        data-nb-outputs="1">
        1 input &amp; 1 output
      </div>
      <div
        class="draggable_operator"
        data-nb-inputs="1"
        data-nb-outputs="2">
        1 in &amp; 2 out
      </div>
      <div
        class="draggable_operator"
        data-nb-inputs="2"
        data-nb-outputs="1">
        2 in &amp; 1 out
      </div>
      <div
        class="draggable_operator"
        data-nb-inputs="2"
        data-nb-outputs="2">
        2 in &amp; 2 out
      </div>
    </div>
  </div>
  <button class="delete_selected_button">
    Delete selected operator / link
  </button>
  <button
    class="get_data"
    id="get_data">
    Get data
  </button>
  <button
    class="set_data"
    id="set_data">
    Set data
  </button>
  <div>
    <textarea
      id="flowchart_data"
      style="height: 100%; width: 100%"></textarea>
  </div>
</div>
<script>
  $(document).ready(function () {
    var $flowchart = $("#flowchart");
    var $container = $flowchart.parent();

    function Flow2Text() {
      var data = $flowchart.flowchart("getData");
      $("#flowchart_data").val(JSON.stringify(data, null, 2));
    }
    $("#get_data").click(Flow2Text);

    function Text2Flow() {
      var data = JSON.parse($("#flowchart_data").val());
      $flowchart.flowchart("setData", data);
    }
    $("#set_data").click(Text2Flow);

    var cx = $flowchart.width() / 2;
    var cy = $flowchart.height() / 2;

    $flowchart.panzoom();
    // Centering panzoom - not used
    // $flowchart.panzoom(
    //   "pan",
    //   -cx + $container.width() / 2,
    //   -cy + $container.height() / 2
    // );

    // Panzoom zoom handling...
    var possibleZooms = [0.5, 0.75, 1, 2, 3];
    var currentZoom = 2;
    $container.on("mousewheel.focal", function (e) {
      e.preventDefault();
      var delta =
        e.delta || e.originalEvent.wheelDelta || e.originalEvent.detail;
      var zoomOut = delta ? delta < 0 : e.originalEvent.deltaY > 0;
      currentZoom = Math.max(
        0,
        Math.min(possibleZooms.length - 1, currentZoom + (zoomOut * 2 - 1))
      );
      $flowchart.flowchart("setPositionRatio", possibleZooms[currentZoom]);
      $flowchart.panzoom("zoom", possibleZooms[currentZoom], {
        animate: false,
        focal: e,
      });
    });

    var data = {
      operators: {
        0: {
          properties: {
            title: "Load Settings",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "Settings saved in global Application Resources",
              },
            },
          },
          left: 210,
          top: 0,
        },
        1: {
          properties: {
            title: "Index plugins",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "Plugins have been indexed",
              },
            },
          },
          left: 410,
          top: 0,
        },
        2: {
          properties: {
            title: "Run onAppStartup() for all plugins",
            inputs: {
              input_0: {
                label: "For every plugin in the index",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 610,
          top: 10,
        },
        3: {
          properties: {
            title: "Create Tray Task",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "App is ready",
              },
            },
          },
          left: 658,
          top: 230,
        },
        operator1: {
          top: 0,
          left: 0,
          properties: {
            title: "App Launched",
            inputs: {},
            outputs: {
              output_1: {
                label: "Process created",
              },
            },
          },
        },
      },
      links: {
        0: {
          fromOperator: "operator1",
          fromConnector: "output_1",
          fromSubConnector: 0,
          toOperator: "0",
          toConnector: "input_0",
          toSubConnector: 0,
        },
        1: {
          fromOperator: "0",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 1,
          toConnector: "input_0",
          toSubConnector: 0,
        },
        2: {
          fromOperator: "1",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 2,
          toConnector: "input_0",
          toSubConnector: 0,
        },
        3: {
          fromOperator: "2",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 3,
          toConnector: "input_0",
          toSubConnector: 0,
        },
      },
      operatorTypes: {},
    };

    $flowchart.flowchart({
      defaultSelectedLinkColor: "#000055",
      defaultLinkColor: "rgb(0,255,0)",
      grid: 10,
      data: data,
      linkWidth: 5,
      multipleLinksOnInput: true,
      multipleLinksOnOutput: true,
    });

    $flowchart
      .parent()
      .siblings(".delete_selected_button")
      .click(function () {
        $flowchart.flowchart("deleteSelected");
      });

    var $draggableOperators = $(".draggable_operator");

    function getOperatorData($element) {
      var nbInputs = parseInt($element.data("nb-inputs"));
      var nbOutputs = parseInt($element.data("nb-outputs"));
      var data = {
        properties: {
          title: $element.text(),
          inputs: {},
          outputs: {},
        },
      };

      var i = 0;
      for (i = 0; i < nbInputs; i++) {
        data.properties.inputs["input_" + i] = {
          label: "Input " + (i + 1),
        };
      }
      for (i = 0; i < nbOutputs; i++) {
        data.properties.outputs["output_" + i] = {
          label: "Output " + (i + 1),
        };
      }

      return data;
    }

    var operatorId = 0;

    $draggableOperators.draggable({
      cursor: "move",
      opacity: 0.7,

      helper: "clone",
      appendTo: "body",
      zIndex: 1000,

      helper: function (e) {
        var $this = $(this);
        var data = getOperatorData($this);
        return $flowchart.flowchart("getOperatorElement", data);
      },
      stop: function (e, ui) {
        var $this = $(this);
        var elOffset = ui.offset;
        var containerOffset = $container.offset();
        if (
          elOffset.left > containerOffset.left &&
          elOffset.top > containerOffset.top &&
          elOffset.left < containerOffset.left + $container.width() &&
          elOffset.top < containerOffset.top + $container.height()
        ) {
          var flowchartOffset = $flowchart.offset();

          var relativeLeft = elOffset.left - flowchartOffset.left;
          var relativeTop = elOffset.top - flowchartOffset.top;

          var positionRatio = $flowchart.flowchart("getPositionRatio");
          relativeLeft /= positionRatio;
          relativeTop /= positionRatio;

          var data = getOperatorData($this);
          data.left = relativeLeft;
          data.top = relativeTop;

          $flowchart.flowchart("addOperator", data);
        }
      },
    });
  });
</script>
