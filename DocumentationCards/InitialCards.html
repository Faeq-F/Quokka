<style>
  #DefaultDocsContentCard1 {
    height: calc(100% - 20px);
    overflow-y: scroll;
  }

  g[data-link_id="8"] path,
  g[data-link_id="9"] path,
  g[data-link_id="10"] path {
    stroke: red;
  }

  g[data-link_id="11"] path {
    stroke: green;
  }
</style>
<div
  id="DefaultDocsContentCard1"
  class="DocsCard">
  <div id="chart_container">
    <div
      class="flowchart-container"
      id="flowchart"></div>
  </div>
  <!-- Used for creating flowchart -->
  <!-- <div class="draggable_operators">
    <div class="draggable_operators_label">
      Operators (drag and drop them in the flowchart):
    </div>
    <div class="draggable_operators_divs">
      <div
        class="draggable_operator"
        data-nb-inputs="1"
        data-nb-outputs="0">
        1 input
      </div>
      <div
        class="draggable_operator"
        data-nb-inputs="0"
        data-nb-outputs="1">
        1 output
      </div>
      <div
        class="draggable_operator"
        data-nb-inputs="1"
        data-nb-outputs="1">
        1 input &amp; 1 output
      </div>
      <div
        class="draggable_operator"
        data-nb-inputs="1"
        data-nb-outputs="2">
        1 in &amp; 2 out
      </div>
      <div
        class="draggable_operator"
        data-nb-inputs="2"
        data-nb-outputs="1">
        2 in &amp; 1 out
      </div>
      <div
        class="draggable_operator"
        data-nb-inputs="2"
        data-nb-outputs="2">
        2 in &amp; 2 out
      </div>
    </div>
  </div>
  <button class="delete_selected_button">
    Delete selected operator / link
  </button>
  <button
    class="get_data"
    id="get_data">
    Get data
  </button>
  <button
    class="set_data"
    id="set_data">
    Set data
  </button>
  <div>
    <textarea
      id="flowchart_data"
      style="height: 1000px; width: 100%; resize: both"></textarea>
  </div> -->
</div>
<script>
  $(document).ready(function () {
    var $flowchart = $("#flowchart");
    var $container = $flowchart.parent();

    function Flow2Text() {
      var data = $flowchart.flowchart("getData");
      $("#flowchart_data").val(JSON.stringify(data, null, 2));
    }
    $("#get_data").click(Flow2Text);

    function Text2Flow() {
      var data = JSON.parse($("#flowchart_data").val());
      $flowchart.flowchart("setData", data);
    }
    $("#set_data").click(Text2Flow);

    // var cx = $flowchart.width() / 2;
    // var cy = $flowchart.height() / 2;

    $flowchart.panzoom();
    // Centering panzoom - not used
    // $flowchart.panzoom(
    //   "pan",
    //   -cx + $container.width() / 2,
    //   -cy + $container.height() / 2
    // );

    // Panzoom zoom handling...
    var possibleZooms = [0.5, 0.75, 1, 2, 3];
    var currentZoom = 2;
    $container.on("mousewheel.focal", function (e) {
      e.preventDefault();
      var delta =
        e.delta || e.originalEvent.wheelDelta || e.originalEvent.detail;
      var zoomOut = delta ? delta < 0 : e.originalEvent.deltaY > 0;
      currentZoom = Math.max(
        0,
        Math.min(possibleZooms.length - 1, currentZoom + (zoomOut * 2 - 1))
      );
      $flowchart.flowchart("setPositionRatio", possibleZooms[currentZoom]);
      $flowchart.panzoom("zoom", possibleZooms[currentZoom], {
        animate: false,
        focal: e,
      });
    });

    var data = {
      operators: {
        0: {
          properties: {
            title: "Load Settings",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "Settings saved in global Application Resources",
              },
            },
          },
          left: 2,
          top: 101,
        },
        1: {
          properties: {
            title: "Index plugins",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "Plugins have been indexed",
              },
            },
          },
          left: 59,
          top: 209,
        },
        2: {
          properties: {
            title: "Run onAppStartup() for all plugins",
            inputs: {
              input_0: {
                label: "For every plugin in the index",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 0,
          top: 320,
        },
        3: {
          properties: {
            title: "Create Tray Task",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "App is ready",
              },
            },
          },
          left: 72,
          top: 412,
        },
        4: {
          properties: {
            title: "User Interaction",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "User hits any key",
              },
              output_1: {
                label: "Right Click Tray Icon",
              },
            },
          },
          left: 38,
          top: 554,
        },
        5: {
          properties: {
            title: "Check hotkey",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "Result",
              },
            },
          },
          left: 14,
          top: 660,
        },
        6: {
          properties: {
            title: "Matches hotkey?",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "Yes",
              },
              output_1: {
                label: "No",
              },
            },
          },
          left: 0,
          top: 790,
        },
        7: {
          properties: {
            title: "",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 418,
          top: 429,
        },
        8: {
          properties: {
            title: "",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 420,
          top: 963,
        },
        9: {
          properties: {
            title: "Create Search Window",
            inputs: {
              input_0: {
                label: "If one doesn't already exist",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 30,
          top: 1038,
        },
        10: {
          properties: {
            title: "User types in Search Window",
            inputs: {
              input_0: {
                label: "Force focus / input on search window",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 4,
          top: 1242,
        },
        11: {
          properties: {
            title: "Call onQueryChange()",
            inputs: {
              input_0: {
                label: "For every plugin in the index",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 33,
          top: 1348,
        },
        12: {
          properties: {
            title: "Run onSearchWindow()",
            inputs: {
              input_0: {
                label: "For every plugin in the index",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 27,
          top: 1140,
        },
        13: {
          properties: {
            title: "Sort and Display Results",
            inputs: {
              input_0: {
                label: "Concatenate all lists provided by plugins",
              },
            },
            outputs: {},
          },
          left: 7,
          top: 1449,
        },
        14: {
          properties: {
            title: "Launch Context Menu",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "User clicks an option",
              },
            },
          },
          left: 140,
          top: 660,
        },
        15: {
          properties: {
            title: "Open Search Window",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 147,
          top: 927,
        },
        16: {
          properties: {
            title: "Settings",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 707,
          top: 936,
        },
        17: {
          properties: {
            title: "PlugBoard",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 510,
          top: 928,
        },
        18: {
          properties: {
            title: "Exit",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 336,
          top: 930,
        },
        19: {
          properties: {
            title: "Open Settings file",
            inputs: {
              input_0: {
                label: "In text editor set in settings",
              },
            },
            outputs: {},
          },
          left: 663,
          top: 1036,
        },
        20: {
          properties: {
            title: "Open PlugBoard folder",
            inputs: {
              input_0: {
                label: "In File Manager set in settings",
              },
            },
            outputs: {},
          },
          left: 460,
          top: 1035,
        },
        21: {
          properties: {
            title: "Run onAppShutdown()",
            inputs: {
              input_0: {
                label: "For every plugin in the index",
              },
            },
            outputs: {
              output_0: {
                label: "",
              },
            },
          },
          left: 260,
          top: 1033,
        },
        22: {
          properties: {
            title: "App Closed",
            inputs: {
              input_0: {
                label: "",
              },
            },
            outputs: {},
          },
          left: 305,
          top: 1145,
        },
        operator1: {
          top: 8,
          left: 78,
          properties: {
            title: "App Launched",
            inputs: {},
            outputs: {
              output_1: {
                label: "Process created",
              },
            },
          },
        },
      },
      links: {
        0: {
          fromOperator: "operator1",
          fromConnector: "output_1",
          fromSubConnector: 0,
          toOperator: "0",
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        1: {
          fromOperator: "0",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 1,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        2: {
          fromOperator: "1",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 2,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        3: {
          fromOperator: "2",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 3,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        4: {
          fromOperator: "3",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 4,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        5: {
          fromOperator: "4",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 5,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        6: {
          fromOperator: 5,
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 6,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        8: {
          fromOperator: "6",
          fromConnector: "output_1",
          fromSubConnector: 0,
          toOperator: 8,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        9: {
          fromOperator: 8,
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 7,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        10: {
          fromOperator: 7,
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: "4",
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        11: {
          fromOperator: "6",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: "9",
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        12: {
          fromOperator: "9",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: "12",
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        13: {
          fromOperator: "12",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: "10",
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        14: {
          fromOperator: "10",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: "11",
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        15: {
          fromOperator: "11",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: "13",
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        16: {
          fromOperator: "4",
          fromConnector: "output_1",
          fromSubConnector: 0,
          toOperator: 14,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        17: {
          fromOperator: 14,
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 15,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        18: {
          fromOperator: 14,
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 16,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        19: {
          fromOperator: 14,
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 17,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        20: {
          fromOperator: 14,
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 18,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        21: {
          fromOperator: "15",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: "9",
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        22: {
          fromOperator: "16",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 19,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        23: {
          fromOperator: "17",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 20,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        24: {
          fromOperator: "18",
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 21,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
        25: {
          fromOperator: 21,
          fromConnector: "output_0",
          fromSubConnector: 0,
          toOperator: 22,
          toConnector: "input_0",
          toSubConnector: 0,
          color: "rgb(96, 150, 255)",
        },
      },
      operatorTypes: {},
    };

    $flowchart.flowchart({
      defaultSelectedLinkColor: "#ffffff",
      defaultLinkColor: "#ffffff",
      grid: 1,
      data: data,
      linkWidth: 5,
      multipleLinksOnInput: true,
      multipleLinksOnOutput: true,
      verticalConnection: true,
      canUserEditLinks: false,
      onLinkSelect: function () {
        return false;
      },
    });

    function loadFlowchartColor() {
      // primary color
      var hue = getComputedStyle(
        document.querySelector(":root")
      ).getPropertyValue("--hue");
      var primary_color = culori.formatRgb("oklch(0.7 0.2 " + hue);
      //applying
      for (var link of document.getElementsByClassName("flowchart-link")) {
        $flowchart.flowchart(
          "setLinkMainColor",
          link.dataset.link_id,
          primary_color
        );
        //send hover event to refresh view
        link.dispatchEvent(
          new MouseEvent("mouseover", {
            view: window,
            bubbles: true,
            cancelable: true,
          })
        );
        link.dispatchEvent(
          new MouseEvent("mouseout", {
            view: window,
            bubbles: true,
            cancelable: true,
          })
        );
      }
    }
    document
      .getElementsByClassName("slider__input")[0]
      .removeEventListener("click", loadFlowchartColor);
    document
      .getElementsByClassName("slider__input")[0]
      .addEventListener("click", loadFlowchartColor);

    loadFlowchartColor();

    $flowchart
      .parent()
      .siblings(".delete_selected_button")
      .click(function () {
        $flowchart.flowchart("deleteSelected");
      });

    var $draggableOperators = $(".draggable_operator");

    function getOperatorData($element) {
      var nbInputs = parseInt($element.data("nb-inputs"));
      var nbOutputs = parseInt($element.data("nb-outputs"));
      var data = {
        properties: {
          title: $element.text(),
          inputs: {},
          outputs: {},
        },
      };

      var i = 0;
      for (i = 0; i < nbInputs; i++) {
        data.properties.inputs["input_" + i] = {
          label: "Input " + (i + 1),
        };
      }
      for (i = 0; i < nbOutputs; i++) {
        data.properties.outputs["output_" + i] = {
          label: "Output " + (i + 1),
        };
      }

      return data;
    }

    var operatorId = 0;

    $draggableOperators.draggable({
      cursor: "move",
      opacity: 0.7,

      helper: "clone",
      appendTo: "body",
      zIndex: 1000,

      helper: function (e) {
        var $this = $(this);
        var data = getOperatorData($this);
        return $flowchart.flowchart("getOperatorElement", data);
      },
      stop: function (e, ui) {
        var $this = $(this);
        var elOffset = ui.offset;
        var containerOffset = $container.offset();
        if (
          elOffset.left > containerOffset.left &&
          elOffset.top > containerOffset.top &&
          elOffset.left < containerOffset.left + $container.width() &&
          elOffset.top < containerOffset.top + $container.height()
        ) {
          var flowchartOffset = $flowchart.offset();

          var relativeLeft = elOffset.left - flowchartOffset.left;
          var relativeTop = elOffset.top - flowchartOffset.top;

          var positionRatio = $flowchart.flowchart("getPositionRatio");
          relativeLeft /= positionRatio;
          relativeTop /= positionRatio;

          var data = getOperatorData($this);
          data.left = relativeLeft;
          data.top = relativeTop;

          $flowchart.flowchart("addOperator", data);
        }
      },
    });
  });
</script>
